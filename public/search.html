<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtl2-WkzFdv8HKXFChDCJDspBqLDxgKcc&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script>
      function handleSearch(event) {
        event.preventDefault();

        const title = document.getElementById('title').value;
        const type = document.getElementById('typeSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const fetchUrl = `api/activity/search?title=${title}&type=${type}&startDate=${startDate}&endDate=${endDate}`;

        fetch(fetchUrl)
          .then((response) => response.json())
          .then((data) => {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            data.forEach((item) => {
              const div = document.createElement('div');
              div.className = 'bg-white shadow-md rounded-md p-4 mb-4';
              div.innerHTML = `
              <h2 class="text-xl font-bold mb-2">${item.title}</h2>
              <p class="text-gray-700"><strong>Location:</strong></p>
              <div id="map-${item.id}" class="h-80 w-1/2 mt-4"></div>
              <p class="text-gray-700"><strong>Type:</strong> ${item.type_name}</p>
              <p class="text-gray-700"><strong>Start:</strong> ${new Date(
                item.start_from,
              ).toLocaleString()}</p>
              <p class="text-gray-700"><strong>End:</strong> ${new Date(
                item.end_at,
              ).toLocaleString()}</p>
              <p class="text-gray-700"><strong>Attendee Limit:</strong> ${item.attendees_limit}</p>
              <p class="text-gray-700"><strong>Note:</strong> ${item.note}</p>
              `;
              resultsContainer.appendChild(div);

              // Initialize map for each activity
              initMap(item.id, item.latitude, item.longitude);
            });
          })
          .catch((error) => {
            console.error('Error fetching the search results:', error);
          });
      }

      function initMap(id, latitude, longitude) {
        const map = new google.maps.Map(document.getElementById(`map-${id}`), {
          center: { lat: latitude, lng: longitude },
          zoom: 15,
        });

        const marker = new google.maps.Marker({
          position: { lat: latitude, lng: longitude },
          map: map,
        });
      }

      function populateActivityTypes() {
        fetch('/api/activity/types')
          .then((response) => response.json())
          .then((types) => {
            const typeSelect = document.getElementById('typeSelect');
            types.forEach((type) => {
              const option = document.createElement('option');
              option.value = type.id;
              option.textContent = type.name;
              typeSelect.appendChild(option);
            });
          })
          .catch((error) => console.error('Error loading activity types:', error));
      }

      window.onload = populateActivityTypes;
    </script>
  </head>

  <body class="bg-gray-100 p-8">
    <form onsubmit="handleSearch(event)" class="mb-4">
      <input
        type="text"
        id="title"
        name="title"
        placeholder="Enter search terms..."
        class="p-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300"
      />
      <button
        type="submit"
        class="bg-blue-500 text-white p-2 rounded-md cursor-pointer ml-2 hover:bg-blue-600 focus:outline-none focus:ring focus:border-blue-300"
      >
        Search
      </button>
    </form>

    <div id="filters" class="mb-4 flex items-center space-x-4">
      <select
        id="typeSelect"
        class="p-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300"
      >
        <option value="">Select Type</option>
      </select>
      <input
        type="date"
        id="startDate"
        class="p-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300"
      />
      <input
        type="date"
        id="endDate"
        class="p-2 border rounded-md focus:outline-none focus:ring focus:border-blue-300"
      />
    </div>

    <div id="searchResults"></div>
  </body>
</html>
